overlay: 1.0.0
x-speakeasy-jsonpath: rfc9535
info:
  title: Speakeasy Modifications
  version: 0.0.12
  x-speakeasy-metadata:
    after: ""
    before: ""
    type: speakeasy-modifications
actions:
  # Global retry configuration
  - target: $
    update:
      x-speakeasy-retries:
        strategy: backoff
        backoff:
          initialInterval: 500
          maxInterval: 60000
          maxElapsedTime: 3600000
          exponent: 1.5
        statusCodes:
          - 5XX
        retryConnectionErrors: true

  # Service endpoints
  - target: $["paths"]["/health"]["get"]
    update:
      x-speakeasy-group: service
      x-speakeasy-name-override: healthCheck

  # Uplink endpoints
  - target: $["paths"]["/uplink/token"]["post"]
    update:
      x-speakeasy-name-override: createToken

  # Servers list endpoint with pagination
  - target: $["paths"]["/servers"]["get"]
    update:
      x-speakeasy-name-override: list
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - name: pageSize
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Number of items per page
        - name: q
          in: query
          required: false
          schema:
            type: string
          description: Search query
      x-speakeasy-pagination:
        type: offsetLimit
        inputs:
          - name: page
            in: parameters
            type: page
          - name: pageSize
            in: parameters
            type: limit
        outputs:
          results: $.servers
          numPages: $.pagination.totalPages

  # ============================================
  # HIDE single-segment /{name} routes from SDK
  # These are kept in API for backward compatibility
  # but SDK users should use /{namespace}/{name}
  # ============================================
  - target: $["paths"]["/servers/{name}"]
    update:
      x-speakeasy-ignore: true

  - target: $["paths"]["/servers/{name}/deployments"]
    update:
      x-speakeasy-ignore: true

  - target: $["paths"]["/servers/{name}/deployments/{id}"]
    update:
      x-speakeasy-ignore: true

  - target: $["paths"]["/servers/{name}/deployments/{id}/resume"]
    update:
      x-speakeasy-ignore: true

  - target: $["paths"]["/servers/{name}/logs"]
    update:
      x-speakeasy-ignore: true

  # ============================================
  # Rename /{namespace}/{name} routes to clean names
  # These are the only routes exposed in the SDK
  # ============================================
  - target: $["paths"]["/servers/{namespace}/{name}"]["get"]
    update:
      x-speakeasy-name-override: get

  - target: $["paths"]["/servers/{namespace}/{name}/deployments"]["put"]
    update:
      x-speakeasy-name-override: deploy

  - target: $["paths"]["/servers/{namespace}/{name}/deployments"]["get"]
    update:
      x-speakeasy-name-override: listDeployments

  - target: $["paths"]["/servers/{namespace}/{name}/deployments/{id}"]["get"]
    update:
      x-speakeasy-name-override: getDeploymentStatus

  - target: $["paths"]["/servers/{namespace}/{name}/deployments/{id}/resume"]["post"]
    update:
      x-speakeasy-name-override: resumeDeployment

  - target: $["paths"]["/servers/{namespace}/{name}/logs"]["get"]
    update:
      x-speakeasy-name-override: getLogs

  # ============================================
  # Make namespace parameter optional with empty default
  # This allows SDK users to omit namespace for single-segment QNs
  # ============================================
  - target: $["paths"]["/servers/{namespace}/{name}"]["get"]["parameters"][?(@.name=="namespace")]
    update:
      schema:
        type: string
        default: ""
      description: "Server namespace (optional, leave empty for unnamespaced servers)"

  - target: $["paths"]["/servers/{namespace}/{name}/deployments"]["put"]["parameters"][?(@.name=="namespace")]
    update:
      schema:
        type: string
        default: ""
      description: "Server namespace (optional, leave empty for unnamespaced servers)"

  - target: $["paths"]["/servers/{namespace}/{name}/deployments"]["get"]["parameters"][?(@.name=="namespace")]
    update:
      schema:
        type: string
        default: ""
      description: "Server namespace (optional, leave empty for unnamespaced servers)"

  - target: $["paths"]["/servers/{namespace}/{name}/deployments/{id}"]["get"]["parameters"][?(@.name=="namespace")]
    update:
      schema:
        type: string
        default: ""
      description: "Server namespace (optional, leave empty for unnamespaced servers)"

  - target: $["paths"]["/servers/{namespace}/{name}/deployments/{id}/resume"]["post"]["parameters"][?(@.name=="namespace")]
    update:
      schema:
        type: string
        default: ""
      description: "Server namespace (optional, leave empty for unnamespaced servers)"

  - target: $["paths"]["/servers/{namespace}/{name}/logs"]["get"]["parameters"][?(@.name=="namespace")]
    update:
      schema:
        type: string
        default: ""
      description: "Server namespace (optional, leave empty for unnamespaced servers)"
